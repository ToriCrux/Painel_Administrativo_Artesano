name: üöÄ CI - Build Backend (com suporte a vari√°veis de ambiente)

on:
  push:
    branches: [ "workflow" ]
  pull_request:
    branches: [ "workflow" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        ports:
          - 5434:5432
        env:
          POSTGRES_USER: artesano
          POSTGRES_PASSWORD: artesano
          POSTGRES_DB: artesano_db
        options: >-
          --health-cmd="pg_isready -U artesano"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      # üåê Vari√°veis globais (usadas em todos os m√≥dulos)
      SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5434/artesano_db
      SPRING_DATASOURCE_USERNAME: artesano
      SPRING_DATASOURCE_PASSWORD: artesano
      SPRING_FLYWAY_URL: jdbc:postgresql://localhost:5434/artesano_db
      SPRING_FLYWAY_USER: artesano
      SPRING_FLYWAY_PASSWORD: artesano
      SERVER_PORT: 8080
      JWT_SECRET: kKm5G2MIj9aMOK/y6v0tXpLHmv8nciqTmrLb+HlJk3k=
      JWT_EXPIRATION: 28800

    steps:
      # 1Ô∏è‚É£ Clona o reposit√≥rio
      - name: üì¶ Checkout do c√≥digo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Instala JDK 21
      - name: ‚òï Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # 3Ô∏è‚É£ Cache do Maven
      - name: ‚ö° Cache do Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # 4Ô∏è‚É£ Build do mon√≥lito (admin)
      - name: üß± Build do mon√≥lito (admin)
        run: mvn -B -DskipTests clean package --file admin/pom.xml

      # 5Ô∏è‚É£ Build do servi√ßo de autentica√ß√£o
      - name: üîê Build do servi√ßo de autentica√ß√£o
        run: mvn -B -DskipTests clean package --file autenticacao-service/pom.xml

      # 6Ô∏è‚É£ Build do servi√ßo de registro
      - name: üßæ Build do servi√ßo de registro
        run: mvn -B -DskipTests clean package --file registro-service/pom.xml

      # 7Ô∏è‚É£ Conclus√£o
      - name: ‚úÖ Conclus√£o
        run: echo "‚úÖ Build finalizado com sucesso (sem testes)"
